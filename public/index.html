<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Share files, images, videos, and text with the community" />
  <meta name="theme-color" content="#00d4ff" />
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Nafij's Social Share</title>
</head>
<body>
  <!-- Offline Banner -->
  <div id="offline-banner" class="offline-banner" role="alert" aria-live="polite">
    📡 You're offline. Posts will be synced when connection is restored.
  </div>

  <!-- Install Banner -->
  <div id="install-banner" class="install-banner" role="banner">
    <span>📱 Install this app for a better experience!</span>
    <div>
      <button id="install-btn" class="btn-outline" aria-label="Install app">Install</button>
      <button id="dismiss-install" class="btn-outline" aria-label="Dismiss install prompt">Dismiss</button>
    </div>
  </div>

  <!-- Header -->
  <header class="header" role="banner">
    <h1>🚀 Nafij's Social Share</h1>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
      <span id="theme-icon">🌙</span>
    </button>
  </header>

  <!-- Main Content -->
  <main class="container" role="main">
    <!-- Post Creation Form -->
    <section class="card post-form-card fade-in" aria-labelledby="post-heading">
      <h2 id="post-heading">Share Something Amazing</h2>
      <form id="post-form" method="POST" action="/api/posts" enctype="multipart/form-data" role="form">
        <div class="form-group">
          <label for="username">Username (max 20 chars) *</label>
          <input 
            type="text" 
            id="username" 
            name="user" 
            placeholder="Enter your username" 
            maxlength="20" 
            required 
            aria-describedby="username-help"
          />
          <small id="username-help">Your username will be saved for future posts</small>
        </div>

        <div class="form-group">
          <label for="post-text">What's on your mind?</label>
          <textarea 
            id="post-text" 
            name="text" 
            placeholder="Share your thoughts, use emojis! 🎉" 
            rows="4"
            aria-describedby="text-help"
          ></textarea>
          <small id="text-help">Supports emojis and multi-line text</small>
        </div>

        <div class="form-group">
          <label for="file-input">Upload Files</label>
          <div class="file-upload-area" id="file-upload-area">
            <input 
              type="file" 
              id="file-input" 
              name="file" 
              multiple 
              accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
              aria-describedby="file-help"
            />
            <div class="file-upload-text">
              <span>📎 Drag & drop files here or click to browse</span>
              <small>Images, videos, audio, documents supported</small>
            </div>
          </div>
          <small id="file-help">Multiple files supported: images, videos, audio, documents</small>
        </div>

        <div id="file-previews" class="file-previews"></div>

        <div id="upload-progress" class="upload-progress" style="display: none;" role="progressbar" aria-live="polite">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <span class="progress-text">Uploading...</span>
          <button type="button" id="cancel-upload" class="btn-outline">Cancel</button>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn">
          <span>🚀 Share Post</span>
        </button>
      </form>
    </section>

    <!-- Navigation -->
    <nav class="card navigation-card" role="navigation" aria-label="Site navigation">
      <div class="nav-buttons">
        <button class="btn btn-secondary active" data-view="feed">📋 Feed</button>
        <button class="btn btn-outline" data-view="all">🌐 All Posts</button>
        <a href="/info" class="btn btn-outline">ℹ️ About</a>
        <a href="/admin" class="btn btn-outline">⚙️ Admin</a>
      </div>
    </nav>

    <!-- Feed Section -->
    <section class="feed-section" id="feed-section" aria-labelledby="feed-heading">
      <h3 id="feed-heading">Live Feed</h3>
      <div id="posts-feed" class="posts-container" role="feed" aria-live="polite">
        <div class="loading-skeleton">
          <div class="skeleton-post"></div>
          <div class="skeleton-post"></div>
          <div class="skeleton-post"></div>
        </div>
      </div>
      <div id="load-more" class="load-more" style="display: none;">
        <button class="btn btn-outline">Load More Posts</button>
      </div>
    </section>
  </main>

  <!-- Scroll to Top Button -->
  <button class="scroll-top" id="scroll-top" aria-label="Scroll to top">
    ↑
  </button>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-labelledby="lightbox-title">
    <div class="lightbox-content">
      <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
      <div class="lightbox-media"></div>
      <div class="lightbox-controls">
        <button class="btn btn-outline" id="lightbox-download">⬇️ Download</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Global state
    let currentPage = 0;
    let isLoading = false;
    let allPosts = [];
    let currentView = 'feed';
    let deferredPrompt;

    // Theme Management
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const body = document.body;

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      body.classList.add('dark');
      themeIcon.textContent = '☀️';
    }

    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark');
      const isDark = body.classList.contains('dark');
      themeIcon.textContent = isDark ? '☀️' : '🌙';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // Username Management
    const usernameInput = document.getElementById('username');
    const savedUsername = localStorage.getItem('username');
    if (savedUsername) {
      usernameInput.value = savedUsername;
    }

    usernameInput.addEventListener('input', (e) => {
      localStorage.setItem('username', e.target.value);
    });

    // File Upload Handling
    const fileInput = document.getElementById('file-input');
    const fileUploadArea = document.getElementById('file-upload-area');
    const filePreviewsContainer = document.getElementById('file-previews');
    let selectedFiles = [];

    // Drag and drop functionality
    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('drag-over');
    });

    fileUploadArea.addEventListener('dragleave', () => {
      fileUploadArea.classList.remove('drag-over');
    });

    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files);
      handleFileSelection(files);
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleFileSelection(files);
    });

    function handleFileSelection(files) {
      selectedFiles = [...selectedFiles, ...files];
      displayFilePreviews();
    }

    function displayFilePreviews() {
      filePreviewsContainer.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const preview = document.createElement('div');
        preview.className = 'file-preview';
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          preview.appendChild(img);
        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = URL.createObjectURL(file);
          video.controls = true;
          preview.appendChild(video);
        } else if (file.type.startsWith('audio/')) {
          const audio = document.createElement('audio');
          audio.src = URL.createObjectURL(file);
          audio.controls = true;
          preview.appendChild(audio);
        } else {
          const fileIcon = document.createElement('div');
          fileIcon.className = 'file-icon';
          fileIcon.textContent = '📄';
          preview.appendChild(fileIcon);
        }

        const fileName = document.createElement('span');
        fileName.className = 'file-name';
        fileName.textContent = file.name;
        preview.appendChild(fileName);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'file-remove';
        removeBtn.textContent = '×';
        removeBtn.onclick = () => removeFile(index);
        preview.appendChild(removeBtn);

        filePreviewsContainer.appendChild(preview);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      displayFilePreviews();
    }

    // Form submission
    const postForm = document.getElementById('post-form');
    const submitBtn = document.getElementById('submit-btn');
    
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('user', usernameInput.value || 'Anonymous');
      formData.append('text', document.getElementById('post-text').value);
      
      if (selectedFiles.length > 0) {
        selectedFiles.forEach(file => {
          formData.append('files', file);
        });
      }

      submitBtn.innerHTML = '<span>🚀 Posting...</span>';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/posts', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          postForm.reset();
          selectedFiles = [];
          displayFilePreviews();
          loadPosts(true); // Refresh feed
          showNotification('Post shared successfully! 🎉', 'success');
        } else {
          throw new Error('Failed to post');
        }
      } catch (error) {
        console.error('Error posting:', error);
        showNotification('Failed to post. Please try again.', 'error');
      } finally {
        submitBtn.innerHTML = '<span>🚀 Share Post</span>';
        submitBtn.disabled = false;
      }
    });

    // Posts loading and display
    async function loadPosts(refresh = false) {
      if (isLoading) return;
      isLoading = true;

      if (refresh) {
        currentPage = 0;
        allPosts = [];
      }

      try {
        const response = await fetch(`/api/posts?page=${currentPage}&limit=10`);
        const posts = await response.json();
        
        if (refresh) {
          allPosts = posts;
        } else {
          allPosts = [...allPosts, ...posts];
        }
        
        displayPosts(posts, refresh);
        currentPage++;
        
        // Show load more button if there are more posts
        const loadMoreBtn = document.getElementById('load-more');
        if (posts.length === 10) {
          loadMoreBtn.style.display = 'block';
        } else {
          loadMoreBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading posts:', error);
        showNotification('Failed to load posts', 'error');
      } finally {
        isLoading = false;
      }
    }

    function displayPosts(posts, refresh = false) {
      const container = document.getElementById('posts-feed');
      
      if (refresh) {
        container.innerHTML = '';
      }

      if (posts.length === 0 && refresh) {
        container.innerHTML = '<div class="empty-state">No posts yet. Be the first to share something! 🚀</div>';
        return;
      }

      posts.forEach(post => {
        const postElement = createPostElement(post);
        container.appendChild(postElement);
        
        // Animate in
        setTimeout(() => {
          postElement.classList.add('fade-in');
        }, 100);
      });
    }

    function createPostElement(post) {
      const postDiv = document.createElement('article');
      postDiv.className = 'post-card';
      postDiv.setAttribute('data-post-id', post._id);

      const timeAgo = getTimeAgo(new Date(post.createdAt));
      const canDelete = post.user === localStorage.getItem('username');

      let mediaHTML = '';
      if (post.media) {
        const mediaUrl = post.media.startsWith('uploads/') ? `/${post.media}` : post.media;
        
        if (post.fileType?.startsWith('image/')) {
          mediaHTML = `
            <div class="post-media">
              <img src="${mediaUrl}" alt="Post image" onclick="openLightbox('${mediaUrl}', 'image')" />
            </div>
          `;
        } else if (post.fileType?.startsWith('video/')) {
          mediaHTML = `
            <div class="post-media">
              <video controls>
                <source src="${mediaUrl}" type="${post.fileType}">
              </video>
              <button class="media-download" onclick="downloadFile('${mediaUrl}', '${post.media}')">⬇️</button>
            </div>
          `;
        } else if (post.fileType?.startsWith('audio/')) {
          mediaHTML = `
            <div class="post-media">
              <audio controls>
                <source src="${mediaUrl}" type="${post.fileType}">
              </audio>
              <button class="media-download" onclick="downloadFile('${mediaUrl}', '${post.media}')">⬇️</button>
            </div>
          `;
        } else {
          mediaHTML = `
            <div class="post-media">
              <a href="${mediaUrl}" download target="_blank" class="file-attachment">
                📎 Download Attachment
              </a>
            </div>
          `;
        }
      }

      postDiv.innerHTML = `
        <div class="post-header">
          <div class="post-author">
            <strong>${post.user || 'Anonymous'}</strong>
            <span class="post-time">${timeAgo}</span>
          </div>
          ${canDelete ? `<button class="post-delete" onclick="deletePost('${post._id}')" aria-label="Delete post">🗑️</button>` : ''}
        </div>
        
        ${post.text ? `<div class="post-content">${post.text}</div>` : ''}
        
        ${mediaHTML}
        
        <div class="post-actions">
          <button class="like-btn ${post.userLiked ? 'liked' : ''}" onclick="toggleLike('${post._id}')">
            <span class="reaction-icon">❤️</span>
            <span class="like-count">${post.likes || 0}</span>
          </button>
          
          <div class="reactions-dropdown">
            <button class="reactions-btn" onclick="toggleReactions('${post._id}')">
              <span class="reaction-icon">😊</span>
              <span class="reactions-count">${(post.reactions?.total || 0)}</span>
            </button>
            <div class="reactions-menu" id="reactions-${post._id}">
              <button onclick="addReaction('${post._id}', 'love')" class="reaction-option">❤️</button>
              <button onclick="addReaction('${post._id}', 'laugh')" class="reaction-option">😂</button>
              <button onclick="addReaction('${post._id}', 'like')" class="reaction-option">👍</button>
              <button onclick="addReaction('${post._id}', 'wow')" class="reaction-option">😮</button>
              <button onclick="addReaction('${post._id}', 'sad')" class="reaction-option">😢</button>
              <button onclick="addReaction('${post._id}', 'angry')" class="reaction-option">😠</button>
            </div>
          </div>
          
          <button class="comment-btn" onclick="toggleComments('${post._id}')">
            💬 <span class="comment-count">${post.comments?.length || 0}</span>
          </button>
          
          <button class="share-btn" onclick="sharePost('${post._id}')">
            🔗 Share
          </button>
        </div>
        
        <div class="comments-section" id="comments-${post._id}" style="display: none;">
          <div class="comments-list" id="comments-list-${post._id}">
            ${(post.comments || []).map(comment => createCommentHTML(comment, post._id, 0)).join('')}
          </div>
          
          <div class="comment-form">
            <input type="text" placeholder="Add a comment..." class="comment-input" value="${localStorage.getItem('username') || ''}"
                   onkeypress="handleCommentSubmit(event, '${post._id}')" />
            <button onclick="submitComment('${post._id}')" class="btn btn-outline">Post</button>
          </div>
        </div>
      `;

      return postDiv;
    }

    function createCommentHTML(comment, postId, level = 0) {
      const timeAgo = getTimeAgo(new Date(comment.createdAt));
      const canDelete = comment.user === localStorage.getItem('username');
      const maxLevel = 3;
      const indent = level * 20;
      
      return `
        <div class="comment level-${level}" data-comment-id="${comment._id}" style="margin-left: ${indent}px;">
          <div class="comment-header">
            <strong>${comment.user || 'Anonymous'}</strong>
            <span class="comment-time">${timeAgo}</span>
            ${canDelete ? `<button class="comment-delete" onclick="deleteComment('${comment._id}')" aria-label="Delete comment">🗑️</button>` : ''}
          </div>
          <div class="comment-content">${comment.text}</div>
          <div class="comment-actions">
            <button class="like-btn ${comment.userLiked ? 'liked' : ''}" onclick="toggleCommentLike('${comment._id}', '${postId}')">
              <span class="reaction-icon">❤️</span>
              <span class="like-count">${comment.likes || 0}</span>
            </button>
            ${level < maxLevel ? `<button class="reply-btn" onclick="showReplyForm('${comment._id}', '${postId}')">↩️ Reply</button>` : ''}
          </div>
          <div class="reply-form" id="reply-form-${comment._id}" style="display: none;">
            <input type="text" placeholder="Write a reply..." class="reply-input" 
                   onkeypress="handleReplySubmit(event, '${comment._id}', '${postId}')" />
            <button onclick="submitReply('${comment._id}', '${postId}')" class="btn btn-outline">Reply</button>
            <button onclick="hideReplyForm('${comment._id}')" class="btn btn-outline">Cancel</button>
          </div>
          <div class="replies" id="replies-${comment._id}">
            ${(comment.replies || []).map(reply => createCommentHTML(reply, postId, level + 1)).join('')}
          </div>
        </div>
      `;
    }

    // Post interactions
    async function toggleLike(postId) {
      try {
        const response = await fetch(`/api/posts/${postId}/like`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          const likeBtn = document.querySelector(`[data-post-id="${postId}"] .like-btn`);
          const likeCount = likeBtn.querySelector('.like-count');
          
          likeBtn.classList.add('liked');
          likeCount.textContent = result.likes;
          
          // Animate heart
          likeBtn.classList.add('pulse');
          setTimeout(() => likeBtn.classList.remove('pulse'), 300);
        }
      } catch (error) {
        console.error('Error liking post:', error);
      }
    }

    async function addReaction(postId, reactionType) {
      try {
        const response = await fetch(`/api/posts/${postId}/reactions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            type: reactionType,
            username: localStorage.getItem('username') || 'Anonymous'
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          updateReactionsDisplay(postId, result.reactions);
          hideReactions(postId);
        }
      } catch (error) {
        console.error('Error adding reaction:', error);
      }
    }

    function toggleReactions(postId) {
      const menu = document.getElementById(`reactions-${postId}`);
      const isVisible = menu.style.display === 'block';
      
      // Hide all other reaction menus
      document.querySelectorAll('.reactions-menu').forEach(m => m.style.display = 'none');
      
      menu.style.display = isVisible ? 'none' : 'block';
    }

    function hideReactions(postId) {
      document.getElementById(`reactions-${postId}`).style.display = 'none';
    }

    function updateReactionsDisplay(postId, reactions) {
      const reactionsBtn = document.querySelector(`[data-post-id="${postId}"] .reactions-count`);
      reactionsBtn.textContent = reactions.total || 0;
    }

    function toggleComments(postId) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      const isVisible = commentsSection.style.display !== 'none';
      
      commentsSection.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        commentsSection.classList.add('slide-in');
      }
    }

    function handleCommentSubmit(event, postId) {
      if (event.key === 'Enter') {
        submitComment(postId);
      }
    }

    async function submitComment(postId) {
      const input = document.querySelector(`#comments-${postId} .comment-input`);
      const text = input.value.trim();
      
      if (!text) return;
      
      const username = localStorage.getItem('username') || 'Anonymous';
      
      try {
        const response = await fetch(`/api/posts/${postId}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user: username,
            text: text
          })
        });
        
        if (response.ok) {
          input.value = '';
          // Refresh comments or add new comment to DOM
          loadPosts(true);
        }
      } catch (error) {
        console.error('Error posting comment:', error);
      }
    }

    function showReplyForm(commentId, postId) {
      const replyForm = document.getElementById(`reply-form-${commentId}`);
      const replyInput = replyForm.querySelector('.reply-input');
      
      replyForm.style.display = 'block';
      replyInput.focus();
      replyInput.value = localStorage.getItem('username') || '';
    }

    function hideReplyForm(commentId) {
      document.getElementById(`reply-form-${commentId}`).style.display = 'none';
    }

    function handleReplySubmit(event, commentId, postId) {
      if (event.key === 'Enter') {
        submitReply(commentId, postId);
      }
    }

    async function submitReply(commentId, postId) {
      const input = document.querySelector(`#reply-form-${commentId} .reply-input`);
      const text = input.value.trim();
      
      if (!text) return;
      
      const username = localStorage.getItem('username') || 'Anonymous';
      
      try {
        const response = await fetch(`/api/posts/${postId}/comments/${commentId}/replies`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user: username,
            text: text
          })
        });
        
        if (response.ok) {
          input.value = '';
          hideReplyForm(commentId);
          loadPosts(true); // Refresh to show new reply
        }
      } catch (error) {
        console.error('Error posting reply:', error);
      }
    }

    async function toggleCommentLike(commentId, postId) {
      try {
        const response = await fetch(`/api/posts/${postId}/comments/${commentId}/like`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .like-btn`);
          const likeCount = likeBtn.querySelector('.like-count');
          
          likeBtn.classList.add('liked');
          likeCount.textContent = result.likes;
          
          // Animate heart
          likeBtn.classList.add('pulse');
          setTimeout(() => likeBtn.classList.remove('pulse'), 300);
        }
      } catch (error) {
        console.error('Error liking comment:', error);
      }
    }

    async function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post?')) return;
      
      try {
        const response = await fetch(`/api/posts/${postId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: localStorage.getItem('username')
          })
        });
        
        if (response.ok) {
          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          postElement.classList.add('fade-out');
          setTimeout(() => postElement.remove(), 300);
          showNotification('Post deleted successfully', 'success');
        }
      } catch (error) {
        console.error('Error deleting post:', error);
        showNotification('Failed to delete post', 'error');
      }
    }

    function sharePost(postId) {
      const url = `${window.location.origin}#post-${postId}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Check out this post',
          url: url
        });
      } else {
        navigator.clipboard.writeText(url).then(() => {
          showNotification('Link copied to clipboard!', 'success');
        });
      }
    }

    // Lightbox functionality
    function openLightbox(src, type) {
      const lightbox = document.getElementById('lightbox');
      const mediaContainer = lightbox.querySelector('.lightbox-media');
      
      if (type === 'image') {
        mediaContainer.innerHTML = `<img src="${src}" alt="Lightbox image" />`;
      } else if (type === 'video') {
        mediaContainer.innerHTML = `<video src="${src}" controls autoplay />`;
      }
      
      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Set download link
      document.getElementById('lightbox-download').onclick = () => downloadFile(src);
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      lightbox.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Close lightbox on click outside or escape key
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    document.querySelector('.lightbox-close').addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });

    function downloadFile(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || 'download';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Utility functions
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
      
      return date.toLocaleDateString();
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Scroll to Top Button
    const scrollTopBtn = document.getElementById('scroll-top');
    
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        scrollTopBtn.classList.add('visible');
      } else {
        scrollTopBtn.classList.remove('visible');
      }
    });

    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });

    // Infinite scroll
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
        loadPosts();
      }
    });

    // Load more button
    document.getElementById('load-more').addEventListener('click', () => {
      loadPosts();
    });

    // Online/Offline Status
    const offlineBanner = document.getElementById('offline-banner');
    
    window.addEventListener('online', () => {
      offlineBanner.classList.remove('show');
      showNotification('Back online! 🌐', 'success');
    });

    window.addEventListener('offline', () => {
      offlineBanner.classList.add('show');
      showNotification('You are offline 📡', 'warning');
    });

    // PWA Install Prompt
    const installBanner = document.getElementById('install-banner');
    const installBtn = document.getElementById('install-btn');
    const dismissBtn = document.getElementById('dismiss-install');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      if (!localStorage.getItem('install-dismissed')) {
        installBanner.classList.add('show');
      }
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBanner.classList.remove('show');
        
        if (outcome === 'accepted') {
          showNotification('App installed successfully! 🎉', 'success');
        }
      }
    });

    dismissBtn.addEventListener('click', () => {
      installBanner.classList.remove('show');
      localStorage.setItem('install-dismissed', 'true');
    });

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('SW registered:', registration);
          
          // Listen for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showNotification('New version available! Refresh to update.', 'info');
              }
            });
          });
        })
        .catch(error => {
          console.log('SW registration failed:', error);
        });

      // Listen for messages from service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data.type === 'SYNC_COMPLETE') {
          showNotification(event.data.message, 'success');
        }
      });
    }

    // Real-time updates (polling every 15 seconds)
    setInterval(() => {
      if (navigator.onLine && currentView === 'feed') {
        checkForNewPosts();
      }
    }, 15000);

    let lastPostTime = new Date();

    async function checkForNewPosts() {
      try {
        const response = await fetch(`/api/posts/new?since=${lastPostTime.toISOString()}`);
        const newPosts = await response.json();
        
        if (newPosts.length > 0) {
          const container = document.getElementById('posts-feed');
          
          newPosts.reverse().forEach(post => {
            const postElement = createPostElement(post);
            postElement.classList.add('new-post');
            container.insertBefore(postElement, container.firstChild);
            
            // Animate in
            setTimeout(() => {
              postElement.classList.add('fade-in');
              postElement.classList.remove('new-post');
            }, 100);
          });
          
          lastPostTime = new Date(newPosts[0].createdAt);
          showNotification(`${newPosts.length} new post${newPosts.length > 1 ? 's' : ''} added! 🎉`, 'success');
        }
      } catch (error) {
        console.error('Error checking for new posts:', error);
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      loadPosts(true);
      lastPostTime = new Date();
      
      // Add intersection observer for animations
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('fade-in');
          }
        });
      });

      // Observe all cards for animation
      document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
      });
      
      // Close reactions menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.reactions-dropdown')) {
          document.querySelectorAll('.reactions-menu').forEach(menu => {
            menu.style.display = 'none';
          });
        }
      });
    });
  </script>
</body>
</html>